"use strict";var h=Object.create;var p=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var C=Object.getPrototypeOf,L=Object.prototype.hasOwnProperty;var F=(e,r)=>{for(var s in r)p(e,s,{get:r[s],enumerable:!0})},v=(e,r,s,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of g(r))!L.call(e,a)&&a!==s&&p(e,a,{get:()=>r[a],enumerable:!(o=f(r,a))||o.enumerable});return e};var d=(e,r,s)=>(s=e!=null?h(C(e)):{},v(r||!e||!e.__esModule?p(s,"default",{value:e,enumerable:!0}):s,e)),O=e=>v(p({},"__esModule",{value:!0}),e);var N={};F(N,{activate:()=>A,deactivate:()=>M});module.exports=O(N);var t=d(require("vscode")),S=d(require("child_process")),c=d(require("path")),l=d(require("fs"));var i=[],n,m=!1;function A(e){n=t.window.createOutputChannel("Server Autostart"),e.subscriptions.push(n),n.appendLine("[INFO] ===== AI Server Autostart Extension aktiviert ====="),n.show(!0);let r=t.commands.registerCommand("serverAutostart.startServers",()=>{u()}),s=t.commands.registerCommand("serverAutostart.stopServers",()=>{w()}),o=t.commands.registerCommand("serverAutostart.showStatus",()=>{E()});e.subscriptions.push(r,s,o),n.appendLine("[INFO] Starte alle Server beim Extension-Startup..."),setTimeout(()=>u(),2e3)}function u(){if(m){n.appendLine("[WARN] Server sind bereits gestartet"),t.window.showWarningMessage("Server sind bereits gestartet. Verwende Stop vor Start.");return}n.appendLine("[INFO] ===== Starte alle Server ====="),t.window.showInformationMessage("Starte AI-Server...");let e=t.workspace.workspaceFolders;if(!e||e.length===0){n.appendLine("[ERROR] Kein Workspace gefunden"),t.window.showErrorMessage("Kein Workspace ge\xF6ffnet.");return}let r=e[0].uri.fsPath,s=c.join(r,"scripts","manage_servers.ps1"),o=c.join(r,"scripts","start_mcp_server.ps1");I(s),setTimeout(()=>{k(o)},3e3),m=!0}function I(e){if(n.appendLine(`[INFO] Starte Llama + Embedding via: ${e}`),!l.existsSync(e)){n.appendLine(`[ERROR] manage_servers.ps1 nicht gefunden: ${e}`),t.window.showErrorMessage(`Script nicht gefunden: ${e}`);return}let r=t.window.createTerminal({name:"AI Servers",hideFromUser:!1});i.push(r),r.show();let s=`pwsh -NoProfile -Command "& '${e}' -Action 'start-all'"`;n.appendLine(`[CMD] ${s}`),r.sendText(s,!0)}function k(e){if(n.appendLine(`[INFO] Starte Standalone MCP Server: ${e}`),!l.existsSync(e)){n.appendLine(`[WARN] start_mcp_server.ps1 nicht gefunden: ${e}`),n.appendLine("[INFO] MCP Server kann sp\xE4ter manuell gestartet werden");return}let r=t.window.createTerminal({name:"MCP Server",hideFromUser:!1});i.push(r),r.show();let s=`pwsh -NoProfile -Command "& '${e}'"`;n.appendLine(`[CMD] ${s}`),r.sendText(s,!0),n.appendLine("[OK] MCP Server Prozess gestartet")}function w(){n.appendLine("[INFO] ===== Stoppe alle Server ====="),t.window.showInformationMessage("Stoppe alle Server..."),i.forEach(r=>{n.appendLine(`[INFO] Schlie\xDFe Terminal: ${r.name}`),r.dispose()}),i.length=0,[{name:"Llama-Server",cmd:"Get-Process llama-server -ErrorAction SilentlyContinue | Stop-Process -Force"},{name:"Embedding Server",cmd:"Get-Process python -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*embedding_server*' } | Stop-Process -Force"},{name:"MCP Server",cmd:"Get-Process python -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*mcp_server*' } | Stop-Process -Force"}].forEach(({name:r,cmd:s})=>{try{S.execSync(`powershell -NoProfile -Command "${s}"`,{windowsHide:!0}),n.appendLine(`[OK] ${r} gestoppt`)}catch{n.appendLine(`[INFO] ${r} nicht aktiv`)}}),m=!1,n.appendLine("[OK] Alle Server gestoppt"),t.window.showInformationMessage("Alle Server wurden gestoppt.")}function E(){n.appendLine("[INFO] ===== Server Status ====="),t.window.showInformationMessage("Zeige Server Status...");let e=t.workspace.workspaceFolders;if(!e||e.length===0){n.appendLine("[ERROR] Kein Workspace gefunden");return}let r=e[0].uri.fsPath,s=c.join(r,"scripts","manage_servers.ps1"),o=t.window.createTerminal({name:"Server Status",hideFromUser:!1});i.push(o),o.show();let a=`pwsh -NoProfile -Command "& '${s}' -Action 'status'"`;o.sendText(a,!0)}function M(){n.appendLine("[INFO] ===== Extension wird deaktiviert ====="),i.forEach(e=>{e.dispose()}),i.length=0,w()}0&&(module.exports={activate,deactivate});
