"use strict";var $=Object.create;var m=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var b=(e,o)=>{for(var r in o)m(e,r,{get:o[r],enumerable:!0})},v=(e,o,r,a)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of C(o))!E.call(e,s)&&s!==r&&m(e,s,{get:()=>o[s],enumerable:!(a=y(o,s))||a.enumerable});return e};var u=(e,o,r)=>(r=e!=null?$(M(e)):{},v(o||!e||!e.__esModule?m(r,"default",{value:e,enumerable:!0}):r,e)),A=e=>v(m({},"__esModule",{value:!0}),e);var N={};b(N,{activate:()=>x,deactivate:()=>k});module.exports=A(N);var t=u(require("vscode")),l=u(require("child_process")),P=u(require("path")),p=u(require("fs")),g=[],d=[],n;function x(e){n=t.window.createOutputChannel("Llama Autostart"),e.subscriptions.push(n),n.appendLine("=== Llama Autostart Extension aktiviert ==="),n.show(),t.window.showInformationMessage("Llama Autostart Extension wurde aktiviert!"),console.log("Llama Autostart Extension aktiviert.");let o=t.commands.registerCommand("llamaAutostart.startServers",()=>{S()}),r=t.commands.registerCommand("llamaAutostart.stopServers",()=>{F()});e.subscriptions.push(o,r),S()}function S(){n.appendLine("=== startServers() aufgerufen ===");let e=t.workspace.getConfiguration("llamaAutostart"),o=e.get("autostartScriptPath"),r=e.get("mcpConfigPath"),a=e.get("enableMcpServer",!0),s=e.get("useIntegratedTerminal",!0);n.appendLine("Konfiguration gelesen:"),n.appendLine(`  scriptPath: ${o}`),n.appendLine(`  mcpConfigPath: ${r}`),n.appendLine(`  enableMcpServer: ${a}`),n.appendLine(`  useIntegratedTerminal: ${s}`),o?I(o,s):t.window.showWarningMessage("Llama Autostart: Kein Pfad zum Llama-Startscript konfiguriert."),a&&r&&T(r,s)}function F(){t.window.showInformationMessage("Llama Autostart: Stoppe Server..."),d.forEach(e=>{e.dispose()}),d.length=0;try{l.execSync('powershell -NoProfile -Command "Get-Process llama-server -ErrorAction SilentlyContinue | Stop-Process -Force"',{windowsHide:!0}),t.window.showInformationMessage("llama-server gestoppt")}catch{console.log("Kein llama-server-Prozess gefunden oder Fehler beim Stoppen")}g.forEach(e=>{try{process.kill(e.pid,"SIGTERM"),console.log(`${e.name} (PID: ${e.pid}) gestoppt`)}catch(o){console.log(`Fehler beim Stoppen von ${e.name} (PID: ${e.pid}):`,o)}}),g.length=0;try{l.execSync(`powershell -NoProfile -Command "Get-Process python -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*web_mcp.py*' } | Stop-Process -Force"`,{windowsHide:!0})}catch{console.log("Keine MCP Python-Prozesse gefunden")}}function I(e,o){if(n.appendLine("=== startLlamaServer() aufgerufen ==="),n.appendLine(`  scriptPath: ${e}`),n.appendLine(`  useIntegratedTerminal: ${o}`),!p.existsSync(e)){n.appendLine("  FEHLER: Startscript nicht gefunden!"),t.window.showErrorMessage(`Llama Autostart: Startscript nicht gefunden: ${e}`);return}if(n.appendLine("  Script existiert, starte Server..."),t.window.showInformationMessage("Llama Autostart: Starte Llama-Server..."),o){let r=t.window.createTerminal({name:"Llama Server",hideFromUser:!1});d.push(r),n.appendLine('  Terminal erstellt: "Llama Server"'),n.appendLine(`  Starte Befehl: powershell -NoProfile -ExecutionPolicy Bypass -File "${e}"`),r.show(),r.sendText(`powershell -NoProfile -ExecutionPolicy Bypass -File "${e}"`,!0),n.appendLine("  Befehl gesendet!"),setTimeout(()=>{t.window.showInformationMessage("Llama Autostart: Llama-Server wurde gestartet (siehe Terminal).")},2e3)}else{let r=l.spawn("powershell",["-NoProfile","-ExecutionPolicy","Bypass","-File",e],{detached:!0,stdio:"ignore",windowsHide:!1});r.unref(),r.on("error",a=>{t.window.showErrorMessage("Llama Autostart: Fehler beim Starten des Scripts: "+a.message)}),setTimeout(()=>{t.window.showInformationMessage("Llama Autostart: Llama-Server wurde gestartet.")},2e3)}}function T(e,o){if(!p.existsSync(e)){t.window.showWarningMessage(`Llama Autostart: mcp.json nicht gefunden: ${e}`);return}try{let a=JSON.parse(p.readFileSync(e,"utf-8")).servers||{};Object.entries(a).forEach(([s,c])=>{if(c.autoStart===!1){console.log(`MCP-Server "${s}" \xFCbersprungen (autoStart = false)`);return}if(!c.command){console.log(`MCP-Server "${s}" hat kein command-Feld`);return}t.window.showInformationMessage(`Llama Autostart: Starte MCP-Server "${s}"...`);let h=c.args||[],f=c.cwd||P.dirname(e);if(o){let i=t.window.createTerminal({name:`MCP: ${s}`,cwd:f,hideFromUser:!1});d.push(i);let w=h.map(L=>`"${L}"`).join(" ");i.sendText(`& "${c.command}" ${w}`),console.log(`MCP-Server "${s}" gestartet im Terminal`)}else{let i=l.spawn(c.command,h,{cwd:f,detached:!0,stdio:"ignore"});i.unref(),i.pid&&g.push({name:`mcp-${s}`,pid:i.pid}),i.on("error",w=>{t.window.showErrorMessage(`MCP-Server "${s}" konnte nicht gestartet werden: ${w.message}`)}),console.log(`MCP-Server "${s}" gestartet (PID: ${i.pid})`)}})}catch(r){t.window.showErrorMessage(`Fehler beim Laden der mcp.json: ${r.message}`)}}function k(){console.log("Llama Autostart Extension wird deaktiviert - stoppe Server..."),d.forEach(e=>{e.dispose()});try{l.execSync('powershell -NoProfile -Command "Get-Process llama-server -ErrorAction SilentlyContinue | Stop-Process -Force"',{windowsHide:!0}),console.log("llama-server gestoppt")}catch{console.log("Kein llama-server-Prozess gefunden oder Fehler beim Stoppen")}g.forEach(e=>{try{process.kill(e.pid,"SIGTERM"),console.log(`${e.name} (PID: ${e.pid}) gestoppt`)}catch(o){console.log(`Fehler beim Stoppen von ${e.name} (PID: ${e.pid}):`,o)}});try{l.execSync(`powershell -NoProfile -Command "Get-Process python -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*web_mcp.py*' } | Stop-Process -Force"`,{windowsHide:!0}),console.log("MCP Python-Prozesse gestoppt")}catch{console.log("Keine MCP Python-Prozesse gefunden oder Fehler beim Stoppen")}}0&&(module.exports={activate,deactivate});
